<!DOCTYPE>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>HTML5 Three.js 3D起火/燃烧动画</title>
	<style>
		* {
			margin: 0;
			padding: 0;
		}

		html {
			height: 100%;
		}

		body {
			height: 100%;
			width: 100%;
			overflow: hidden;
		}

		canvas {
			position: absolute;
		}

		#canvas {
			width: 100%;
			height: 100%;
		}
	</style>
	<script type="module">
		import * as THREE from '../../../build/three.module.js';
		import {OrbitControls} from "../../jsm/controls/OrbitControls.js";
		import {GLTFLoader} from '../../jsm/loaders/GLTFLoader.js';
		import {GUI} from "../../jsm/libs/dat.gui.module.js";

		import {FirePoints} from "./firePoints.js";

		window.onload = function () {
			var width = document.body.clientWidth;
			var height = document.body.clientHeight;

			var renderer = new THREE.WebGLRenderer({
				antialias: true
			});
			renderer.setSize(width, height);
			renderer.setClearColor(0x111111, 1.0);
			var canvas = document.getElementById('canvas');
			canvas.appendChild(renderer.domElement);

			var scene = new THREE.Scene();
			// scene.fog = new THREE.Fog(0x000000, 0, 1600);
			window.scene = scene;

			var camera = new THREE.PerspectiveCamera(35, width / height, 1, 10000);
			camera.up.set(0, 1, 0);
			camera.position.set(30.60348174361273, 8.605740382075744, -9.030565859614356);
			window.camera = camera;

			var orbitControls = new OrbitControls(camera, renderer.domElement);

			var ambientLight = new THREE.AmbientLight(0xcccccc, 1.0);
			scene.add(ambientLight);

			var light = new THREE.HemisphereLight(0xffff99, 0xffff99, 1.0);
			light.position.set(433.01270189221947, 866.0254037844386, 250);
			scene.add(light);

			var firePoints;

			var loader = new GLTFLoader().setPath('../../models/gltf/');
			loader.load('daodan.glb', function (gltf) {

				scene.add(gltf.scene);

				// 火焰粒子
				var options = {};
				firePoints = new FirePoints(options);
				firePoints.renderNode.position.set(0, 0.39, -3.45);
				gltf.scene.add(firePoints.renderNode);

				enableGUI(firePoints);
			});

			function enableGUI(firePoints) {

				let gui = new GUI();
				let param = {
					positionX: firePoints.renderNode.position.x,
					positionY: firePoints.renderNode.position.y,
					positionZ: firePoints.renderNode.position.z,
					size: firePoints.size,
					acceleration: firePoints.acceleration,
					activeNum: firePoints.activeNum,
					length: firePoints.length,
					diffusionSpeed:firePoints.diffusionSpeed
				};
				let firePointControll = gui.addFolder("火焰参数");
				firePointControll.add(param, 'positionX', param.positionX - 50, param.positionX + 50).step(0.01).onChange(function (val) {
					firePoints.renderNode.position.x = val;
				})
				firePointControll.add(param, 'positionY', param.positionY - 50, param.positionY + 50).step(0.01).onChange(function (val) {
					firePoints.renderNode.position.y = val;
				})
				firePointControll.add(param, 'positionZ', param.positionZ - 50, param.positionZ + 50).step(0.01).onChange(function (val) {
					firePoints.renderNode.position.z = val;
				})
				firePointControll.add(param, 'size', 0.1, param.size + 10).step(0.1).onChange(function (val) {
					firePoints.renderNode.material.size = val;
				})
				firePointControll.add(param, 'acceleration', 0, param.acceleration + 1).step(0.01).onChange(function (val) {
					firePoints.acceleration = val;
				})
				firePointControll.add(param, 'activeNum', 2, param.activeNum + 50).step(1).onChange(function (val) {
					firePoints.activeNum = val;
				})
				firePointControll.add(param, 'length', 1, param.length + 20).step(1).onChange(function (val) {
					firePoints.length = val;
				})
				firePointControll.add(param, 'diffusionSpeed', 0.01, param.diffusionSpeed + 0.1).step(0.01).onChange(function (val) {
					firePoints.diffusionSpeed = val;
				})
			}

			var raycaster = new THREE.Raycaster();
			var mouse = new THREE.Vector2();

			function onclick(event) {
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

				raycaster.setFromCamera(mouse, camera);
				var intersects = raycaster.intersectObjects(scene.children, true);
				console.log(intersects);
			}


			// 平面
			var plane_geometry = new THREE.PlaneGeometry(500, 500, 16, 16);
			var plane_material = new THREE.MeshLambertMaterial({
				color: 0xffffff,
				wireframe: true
			});
			var plane_obj = new THREE.Mesh(plane_geometry, plane_material);
			plane_obj.rotation.set(Math.PI / 2, 0, Math.PI / 2);
			scene.add(plane_obj);

			animate();

			function animate() {
				requestAnimationFrame(animate);

				render();
			}

			function render() {
				renderer.clear();
				firePoints && firePoints.update();
				renderer.render(scene, camera);
			}

			window.addEventListener("resize", function () {
				width = document.body.clientWidth;
				height = document.body.clientHeight;

				camera.aspect = width / height;
				camera.updateProjectionMatrix();

				renderer.setSize(width, height);
				// camera.resize(width, height);
			});
			window.addEventListener('click', onclick, false);
		}
	</script>
</head>

<body>
<div id="canvas"></div>
<canvas id="show_canvas"></canvas>
</body>
</html>